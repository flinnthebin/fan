#!/usr/bin/env sh

I8KCTL=/usr/bin/i8kctl

# Check if i8kctl exists and is executable
if [ ! -x "$I8KCTL" ]; then
    echo "Error: i8kfan needs $I8KCTL"
    exit 1
fi

# Handle command-line options
if [[ "$1" == "-h" ]]; then
    echo "Usage: i8kfan [left right]"
    echo "       i8kfan [-v]"
    exit 0
elif [[ "$1" == "-v" ]]; then
    exec "$I8KCTL" "-v"
elif [ "$#" -gt 0 ]; then
    # If arguments are provided, pass them to i8kctl fan
    exec "$I8KCTL" "fan" "$@"
else
    # No arguments provided, show menu with whiptail
    CHOICE=$(whiptail --title "Fan Speed Selection" --menu "Choose your option" 15 60 4 \
    "1" "Off" \
    "2" "Low" \
    "3" "High" \
    "4" "Intense" 3>&1 1>&2 2>&3)

    exitstatus=$?

    if [ "$exitstatus" = 0 ]; then
        case $CHOICE in
            1)
                # Off: Both fans off
                COMMANDS=("fan 0 0")
                ;;
            2)
                # Low: Set fans to off, wait 5 seconds, then set left fan to low, right fan off
                COMMANDS=("fan 0 0" "sleep 1" "fan 1 -1")
                ;;
            3)
                # High: Both fans to low speed
                COMMANDS=("fan 1 1")
                ;;
            4)
                # Intense: Both fans to high speed
                COMMANDS=("fan 2 2")
                ;;
            *)
                echo "Invalid choice"
                exit 1
                ;;
        esac

        if [ "$(id -u)" != "0" ]; then
            SUDO="sudo"
        else
            SUDO=""
        fi

        # Execute the commands
        for CMD in "${COMMANDS[@]}"; do
            if [[ "$CMD" == "sleep "* ]]; then
                SLEEP_DURATION="${CMD#sleep }"
                sleep "$SLEEP_DURATION"
            else
                $SUDO "$I8KCTL" $CMD
            fi
        done
    else
        echo "Operation cancelled by user."
        exit 1
    fi
fi
